## チームラボ選考課題 -チューニング内容説明-

### ◇ 前提

  * <b>元のサンプルアプリケーションは、検索仕様を全て満たしている</b>  

    * page テーブルの title カラムを前方一致でキーワード検索し、ユーザID(第1ソート昇順)、ぺージID(第2ソート昇順)で10件取得可能
    * 結果の件数と表示順は正しい  
    * 検索スピードだけが遅い
    
    　　
      　　
### ◇ テストケース(現状の検索状況の把握)
  * <b>元のサンプルの検索結果を記録</b>  
  　　
    　　
      　　
        　　
          　　
            　　
              　　
                　　
                  　　
                    
    検索ワードは以下４つ  
```
      　「aa」・・・・・・・検索にかかる時間が長く、パフォーマンス改善結果に期待できるため選定  
      　「C言語」・・・・・第1、第2ソートが効いているかチェックするため選定  
      　「Sandbox」・・・・閲覧数が複数ある検索ワードのため選定(閲覧数がカウントされることを確認する)  
      　「アップロード」・・ 閲覧数が複数ある検索ワードのため選定(閲覧数がカウントされることを確認する)  
```  
　　
  　　
    　　
      
　　　　　　　　　　　　表1：チューニング前のテスト結果  

No| 検索ワード |チェック項目 | 1回目 |2回目 | 3回目
:---:|:---:|:---:|:---:|:---:|:---:
1| aa | ミリ秒 |181746|170410|155867
2| aa | 件数 |242|242|242
3| aa | 第1ソート（ユーザID） |表示なし|表示なし|表示なし
4| aa | 第2ソート（ぺージID） |◯|◯|◯
5| C言語| ミリ秒 |10711|9460|10236
6| C言語| 件数 |102|102|102
7| C言語| 第1ソート（ユーザID） |◯|◯|◯
8| C言語| 第2ソート（ぺージID） |◯|◯|◯
9| Sandbox| ミリ秒 |24982|24809|24734
10| Sandbox| 件数 |213|213|213
11| Sandbox| 第1ソート（ユーザID） |◯|◯|◯
12| Sandbox| 第2ソート（ぺージID） |◯|◯|◯
13| アップロード| ミリ秒 |27069|27854|27495
14| アップロード| 件数 |129|129|129
15| アップロード| 第1ソート（ユーザID） |◯|◯|◯
16| アップロード| 第2ソート（ぺージID） |◯|◯|◯


  
　　
  　　
    
 * <b>チューニング前の検索結果</b>

    * 最速で9460ミリ秒、最遅で181746ミリ秒かかる
    * 表示順は、検索仕様通り
    * 検索件数は、3回のテストで同じ結果となる
    * 検索ワードによって、ぺージタイトルカラム、ぺージIDカラム以外がNULLの場合がある
    * ユーザIDカラムがNULLの場合、NULLは最大値として扱われている
    * 閲覧数カウント「Sandbox」「アップロード」に関して、閲覧数が2回になるケースがある  


　　
  　　
### ◇ 修正方針

  *  クエリビルダを用いて結果を取得することでスピードアップを狙う(for文とif文を用いての全件比較をしない)  
  *  検索ワードが空で検索された場合は、空の結果を返すようにする  
  * ユーザーIDがNULLの場合を考慮する(昇順でソートした時に、NULLが最大値として扱われるようにする)  


　　
  　　
    
### ◇ 修正内容  

  修正ファイル : /app/Http/Libs/PageUtility.php

　　
  　　
    
<b>検索キーワードが「なし(空)」の場合、空の配列を返す</b>   
```php
          if(empty($keyword)) {
              return [];
          }
```
　　
  　　
    
<b>検索キーワードを引数にし、クエリビルダを用いて検索結果を取得する</b>  

  * 閲覧数のカウントを、COUNT(activity.user_id)にて取得する
  * ぺージテーブルを軸に、アクティビティテーブル、ユーザーテーブルをLEFTJOINする
  * orderbyを2つに分け、ぺージIDのソートがorderbyrawの影響を受けないようにする  

  ```php
   private static function getUserPageObject($keyword){
      $result = Page::select(DB::raw("page.id AS page_id,user.name as user_name,activity.user_id as user_id,page.title as page_title,COUNT(activity.user_id) as view_count"))
               ->leftJoin('activity','page.id', '=', 'activity.page_id')
               ->leftJoin('user', 'user.id', '=', 'activity.user_id')
               ->where('page.title','LIKE', "$keyword%")
               ->groupby ('activity.user_id', 'user.name', 'page.id', 'page.title')
               ->orderbyraw('activity.user_id IS NULL ASC')
               ->orderby('activity.user_id','ASC')
               ->orderby('page.id','ASC')
               ->get();

     return $result;
   }
```

　　
  　　
    
<b>結果をオブジェクト型から、配列に変換する</b>  

```php
private static function convertDataObjectToDataArray($userPageObject){
    $userPageString = json_encode($userPageObject);
    $userPageArray = json_decode($userPageString, TRUE);

    return $userPageArray;
}
```


  　
### ◇ チューニング後の結果

　　
  　　
    
　　　　　　　　　　　　表2：チューニング後のテスト結果  

No| 検索ワード |チェック項目 | 1回目 |2回目 | 3回目
:---:|:---:|:---:|:---:|:---:|:---:
1| aa | ミリ秒 |1674|1748|1862
2| aa | 件数 |242|242|242
3| aa | 第1ソート（ユーザID） |表示なし|表示なし|表示なし
4| aa | 第2ソート（ぺージID） |◯|◯|◯
5| C言語| ミリ秒 |503|493|545
6| C言語| 件数 |102|102|102
7| C言語| 第1ソート（ユーザID） |◯|◯|◯
8| C言語| 第2ソート（ぺージID） |◯|◯|◯
9| Sandbox| ミリ秒 |559|600|584
10| Sandbox| 件数 |213|213|213
11| Sandbox| 第1ソート（ユーザID） |◯|◯|◯
12| Sandbox| 第2ソート（ぺージID） |◯|◯|◯
13| アップロード| ミリ秒 |649|683|698
14| アップロード| 件数 |129|129|129
15| アップロード| 第1ソート（ユーザID） |◯|◯|◯
16| アップロード| 第2ソート（ぺージID） |◯|◯|◯


　　
  
### ◇ 結果の比較
* <b>チューニング前と後での検索スピードを比較する</b>  

  * 件数、第1ソート、第2ソートは、チューニング前後で同じになっていることを確認  
  * 表3の結果は、各3回の結果の平均値を記載している  


　　
  　　
    
　　　　　　　　　　　　表3：チューニング前後の結果比較

No| 検索ワード |チューニング前　(ミリ秒) |チューニング後　(ミリ秒)|時間削減率　(%)
:---:|:---:|:---:|:---:|:---:|
1| aa |169341|1761|98.96
2| C言語 |10135|513|94.93
3| Sandbox |24841|581|97.66
4| アップロード|27472|676|97.53


　　
  　　
    
検索にかかった時間を比較した結果、平均97.27%の検索時間の削減に成功した。
